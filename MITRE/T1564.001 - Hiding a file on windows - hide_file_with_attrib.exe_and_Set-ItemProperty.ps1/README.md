
## T1564.001 Traces

Execution of powershell script [hide_file_with_attrib.exe_and_Set-ItemProperty.ps1](https://raw.githubusercontent.com/mthcht/Purpleteam/main/Simulation/Windows/System/hide_file_with_attrib.exe_and_Set-ItemProperty.ps1)
from windows [simulation scripts repo](https://github.com/mthcht/Purpleteam/tree/main/Simulation/Windows).

This script is used to simulated [T1564.001](https://attack.mitre.org/techniques/T1564/001/) MITRE technique and trigger Sysmon EventID 1 or Security EventID 4688.

In these directories you should see all the EventID details triggered by the execution of the script.

### Triggered Events
| EventLog Path                            | EventIDs       |
|------------------------------------------|----------------|
| Security                                 | 4688           |
| Microsoft-Windows-PowerShell/Operational | 4104           |
| Windows PowerShell                       | 400,403,600    |
| Microsoft-Windows-Sysmon/Operational     | 1,26           |

### Sysmon EventID 1 and Security EventID 4688:
Event ID 1: Process creation
The process creation event provides extended information about a newly created process.
The full command line provides context on the process execution.
The ProcessGUID field is a unique value for this process across a domain to make event correlation easier.
The hash is a full hash of the file with the algorithms in the HashType field.

Here we have executed the script:
![2022-12-21 15_31_26-Windows 10 and later x64 - VMware Workstation](https://user-images.githubusercontent.com/75267080/208973025-1adf4922-966c-4098-82e1-e409bc007e00.png)
First Log is from Sysmon EventID 1, we can see the first hiding method of our script `attrib.exe +h` hiding the file file_to_hide.txt with parent process powershell and the commandline of the parent powershell.
The parent commandline is specific to Sysmon, Security log EventID 4688 is not showing our script, only the parent powershell (we also have a hashes of the processes with sysmon, which can be really usefull for other binaries)


### Microsoft-Windows-PowerShell/Operational EventID 4104
The second method used is `Set-ItemProperty -Path $attribPath -Name 'Attributes' -Value 'Hidden'`, this has been added to simulate another way of hiding a file on windows which is less known and more difficult to detect.
the only way we can find it is with the EventID 4104:
![2022-12-21 19_30_08-Observateur d'événements](https://user-images.githubusercontent.com/75267080/208978313-a32eaf44-4e04-4c98-8a8c-1cfe2b2b4650.png)

Powershell commands here or full script content will be logged in this EventID.
Powershell EventID 4104 can generate a lot of noise, make it difficult to collect, it is the preferred method of attackers as the command Set-ItemProperty could generate more False positives than attrib.exe and is generally not supervised by detection rules.

Our file is now hidden, you can still show hidden files in windows file option or with the command `Get-ChildItem -Force`:
![image](https://user-images.githubusercontent.com/75267080/208982978-7565e8fc-4a0f-4cf6-8827-4f2ac6aac195.png)


### Detection:
Look for Sysmon EventID 1 or Security EventID 4688 or Microsoft-Windows-PowerShell/Operational EventID 4104

- Detection proposals
  - Process execution with CommandLine containing `attrib.exe* +h *`
  - Powershell Creating Scriptblock text EventID 4104 with ScriptBlockText value containing `Set-ItemProperty * 'Attributes' * 'Hidden*`, this can also be seen in process execution events if directly set as argument in a cmd prompt executing powershell.
  
 
 The other EventID generated by the script should be used for event correlation as they are specific the methods i used here.
