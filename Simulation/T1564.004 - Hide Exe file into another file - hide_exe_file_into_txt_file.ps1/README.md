## T1564.004 Traces

Executions of powershell script [hide_exe_file_into_txt_file.ps1](https://raw.githubusercontent.com/mthcht/Purpleteam/main/Simulation/Windows/System/hide_exe_file_into_txt_file.ps1)
from windows [simulation scripts repo](https://github.com/mthcht/Purpleteam/tree/main/Simulation/Windows).

This script is used to simulated [T1564.004 ](https://attack.mitre.org/techniques/T1564/004/) MITRE technique and trigger Sysmon EventID 15.

In these directories you should see all the EventID details triggered by the execution of the script.

### Triggered Events
| EventLog Path                            | EventIDs       |
|------------------------------------------|----------------|
| Security                                 | 4688           |
| Microsoft-Windows-PowerShell/Operational | 4104           |
| Windows PowerShell                       | 400,403,600    |
| Microsoft-Windows-Sysmon/Operational     | 15             |

### EventID 15:
Event ID 15: FileCreateStreamHash
This event logs when a named file stream is created, and it generates events that log the hash of the contents of the file to which the stream is assigned (the unnamed stream), as well as the contents of the named stream.
There are malware variants that drop their executables or configuration settings via browser downloads, and this event is aimed at capturing that based on the browser attaching a Zone.Identifier "mark of the web" stream.

Here we have executed the content of the script, adding the executable hello.exe (valid .exe file that does nothing) to the file test.txt:
![2022-12-20 20_18_26-Windows 10 and later x64 - VMware Workstation](https://user-images.githubusercontent.com/75267080/208753880-71cdab38-13c0-4fae-a019-cedc79d11af6.png)

At the end of the script, the command `Get-item` with the parameter `-Stream *` is showing the stream of the txt file:
![2022-12-20 20_50_29-Windows 10 and later x64 - VMware Workstation](https://user-images.githubusercontent.com/75267080/208754562-133cede8-c8ca-4c1a-8fd1-451593765e78.png)

We can still open the file.txt normally and our binary hello.exe is available in the test.txt stream.

**There is a notable difference when you add an executable file to a file stream, the IMPHASH will always be filled. as you can see in the event log above**

Different from other contents:

Here is an example of adding a secret message to the file test.txt, just a string to the file stream:  
![image](https://user-images.githubusercontent.com/75267080/208755812-a3482453-ca9d-4310-ba92-ebefb30801d2.png)
The IMPHASH is 0000000000000000000000... 

![2022-12-20 20_59_31-Windows 10 and later x64 - VMware Workstation](https://user-images.githubusercontent.com/75267080/208755834-4b373e12-adb1-4491-8507-270720b878d0.png)

### Detection:
Look for EventID 15 with IMPHASH value different than 0000000000000000000...

Events with 0000000000000000000000 can also be monitored but are subject to false positives.


- Detection proposals
  - Create a detection rule only for EventID 15 with IMPHASH different than 000* (executables in ADS), this behavior should not be seen legitimatly, this is a very rare event.

The other EventID generated by the script should be used for event correlation as they are specific the method i used here:
- powershell event log events allows us to retrive the script executed and his content
- security event logs allows us to see how the script was executed.
These are specifically triggered by this script but other methods of group enumeration can be logged elsewhere, the important EventID that should be triggered everytime is EventID 15 (Sysmon).
